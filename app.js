const express = require('express');
const bodyParser = require('body-parser');
const app = express();
const fetch = require('node-fetch');
app.use(bodyParser.json());
const distDir = __dirname + '/www/';
const { createProxyMiddleware } = require('http-proxy-middleware');
var cron = require('node-cron');
const fs = require('fs');
app.use(express.static(distDir));

const sapis = [
    `51.75.158.4`,
    `75.60.241.114`,
    `85.217.171.185`,
    `167.86.91.147`,
    `51.75.158.25`,
    `185.216.231.73`,
    `167.86.89.56`,
    `207.180.200.240`,
    `207.180.211.105`,
    `135.181.85.180`,
    `135.181.85.177`,
    `135.181.85.186`,
    `135.181.85.188`,
    `135.181.85.176`,
    `135.181.85.183`,
    `135.181.85.184`,
    `135.181.85.187`,
    `135.181.85.182`,
    `135.181.85.185`,
    `195.201.22.100`,
    `195.201.22.122`,
    `195.201.22.110`,
    `195.201.22.103`,
    `195.201.22.112`,
    `195.201.22.113`,
    `195.201.22.117`,
    `195.201.22.101`,
    `195.201.22.107`,
    `195.201.22.116`,
    `94.102.210.158`,
    `94.102.210.119`,
    `90.145.247.136`,
    `167.86.97.16`,
    `167.86.123.246`,
    `173.249.6.78`,
    `62.171.132.117`,
    `185.141.61.112`,
    `173.249.48.174`,
    `167.86.124.227`,
    `94.156.35.99`,
    `164.68.102.153`,
    `37.24.134.95`,
    `5.44.105.132`,
    `164.68.112.229`,
    `88.198.202.140`,
    `213.52.125.41`,
    `173.249.31.63`,
    `45.32.232.116`,
    `199.247.10.156`,
    `167.86.89.3`,
    `164.68.112.231`,
    `164.68.102.164`,
    `14.161.22.94`,
    `173.249.31.45`,
    `173.249.50.117`,
    `167.86.95.13`,
    `51.77.124.25`,
    `195.201.23.4`,
    `195.201.22.241`,
    `164.68.112.225`,
    `167.86.90.125`,
    `79.143.187.234`,
    `167.86.97.15`,
    `51.77.124.10`,
    `178.238.231.201`,
    `71.45.87.12`,
    `164.68.112.210`,
    `167.86.111.184`,
    `207.180.201.182`,
    `89.181.124.117`,
    `95.165.156.202`,
    `207.180.212.131`,
    `217.160.255.46`,
    `167.86.96.109`,
    `90.145.247.157`,
    `80.241.217.151`,
    `173.82.232.13`,
    `207.180.193.28`,
    `45.76.250.128`,
    `164.68.104.4`,
    `167.86.102.234`,
    `173.249.32.39`,
    `52.230.4.204`,
    `167.86.87.56`,
    `167.86.90.127`,
    `185.205.210.233`,
    `82.146.49.104`,
    `164.68.112.213`,
    `173.249.13.217`,
    `167.86.96.209`,
    `207.180.210.221`,
    `167.86.91.163`,
    `167.86.96.251`,
    `5.187.51.206`,
    `167.86.110.12`,
    `173.249.13.232`,
    `207.180.211.41`,
    `173.249.5.205`,
    `207.180.193.26`,
    `5.187.51.231`,
    `167.86.90.143`,
    `167.86.97.17`,
    `167.86.102.231`,
    `164.68.102.161`,
    `62.171.132.111`,
    `85.214.97.248`,
    `167.86.97.5`,
    `167.86.96.250`,
    `207.180.246.171`,
    `185.141.62.35`,
    `167.86.111.183`,
    `207.180.193.2`,
    `167.86.79.44`,
    `167.86.96.249`,
    `167.86.97.12`,
    `167.86.91.157`,
    `167.86.79.45`,
    `90.145.247.153`,
    `168.119.57.54`,
    `168.119.57.49`,
    `168.119.57.48`,
    `168.119.56.7`,
    `168.119.57.50`,
    `168.119.57.36`,
    `168.119.57.42`,
    `168.119.57.43`,
    `168.119.53.99`,
    `168.119.56.51`,
    `135.181.85.190`,
    `135.181.85.192`,
    `135.181.85.198`,
    `135.181.85.191`,
    `135.181.85.196`,
    `161.97.144.8`,
    `54.38.150.123`,
    `167.86.115.104`,
    `80.241.216.205`,
    `185.205.209.184`,
    `51.68.138.158`,
    `167.86.90.211`,
    `207.180.250.179`,
    `167.86.124.244`,
    `167.86.79.35`,
    `70.99.78.22`,
    `159.203.80.139`,
    `167.86.124.247`,
    `3.64.66.213`,
    `173.249.51.179`,
    `173.249.40.165`,
    `5.187.51.215`,
    `167.86.89.39`,
    `51.75.158.7`,
    `45.76.116.26`,
    `173.212.253.105`,
    `164.68.102.165`,
    `173.82.208.190`,
    `173.249.51.154`,
    `157.90.125.125`,
    `173.249.20.101`,
    `167.86.89.31`,
    `79.143.187.62`,
    `51.75.158.99`,
    `172.104.77.31`,
    `94.156.189.157`,
    `151.252.59.37`,
    `167.86.97.25`,
    `173.249.54.30`,
    `90.145.247.161`,
    `208.64.227.88`,
    `62.171.132.115`,
    `167.86.97.14`,
    `164.68.102.159`,
    `167.86.110.24`,
    `207.148.15.146`,
    `135.181.45.39`,
    `167.86.110.26`,
    `62.171.132.109`,
    `168.119.109.36`,
    `173.212.223.135`,
    `207.180.229.199`,
    `51.77.91.2`,
    `85.214.19.239`,
    `167.86.110.20`,
    `164.68.112.233`,
    `167.86.91.129`,
    `71.45.53.64`,
    `51.15.121.17`,
    `172.86.180.4`,
    `164.68.112.222`,
    `152.228.130.236`,
    `94.102.211.12`,
    `45.63.95.68`,
    `173.249.40.106`,
    `51.15.113.234`,
    `185.205.209.50`,
    `90.145.247.140`,
    `167.86.96.252`,
    `167.86.89.239`,
    `51.75.158.6`,
    `89.149.208.132`,
    `92.222.89.160`,
    `167.86.124.239`,
    `135.181.85.207`,
    `135.181.85.202`,
    `135.181.85.205`,
    `135.181.85.208`,
    `135.181.85.209`,
    `135.181.85.201`,
    `135.181.85.200`,
    `135.181.85.206`,
    `195.201.22.221`,
    `195.201.22.200`,
    `195.201.22.207`,
    `195.201.22.227`,
    `195.201.22.213`,
    `195.201.22.216`,
    `195.201.22.205`,
    `195.201.22.210`,
    `195.201.22.201`,
    `195.201.22.214`,
    `168.119.57.83`,
    `168.119.57.82`,
    `168.119.57.72`,
    `168.119.57.81`,
    `168.119.57.77`,
    `168.119.57.73`,
    `168.119.57.70`,
    `207.180.193.27`,
    `167.86.110.13`,
    `80.241.216.188`,
    `173.212.217.82`,
    `164.68.102.157`,
    `213.52.125.44`,
    `54.38.150.124`,
    `173.212.214.45`,
    `173.249.6.125`,
    `194.132.222.219`,
    `90.145.247.158`,
    `80.241.213.200`,
    `164.68.102.152`,
    `167.86.91.104`,
    `167.86.103.113`,
    `167.86.97.11`,
    `93.104.213.141`,
    `207.180.204.151`,
    `164.68.112.219`,
    `193.38.33.124`,
    `164.68.102.155`,
    `173.249.18.163`,
    `35.204.167.142`,
    `173.212.202.54`,
    `173.249.30.122`,
    `151.252.59.35`,
    `167.86.91.152`,
    `62.171.132.116`,
    `167.86.94.163`,
    `167.86.87.55`,
    `167.86.110.28`,
    `167.86.79.43`,
    `164.68.112.214`,
    `173.212.234.230`,
    `62.109.22.250`,
    `167.86.93.185`,
    `207.180.245.37`,
    `207.180.203.197`,
    `51.75.158.19`,
    `185.195.25.186`,
    `151.252.57.207`,
    `116.203.102.87`,
    `91.121.183.173`,
    `153.92.208.64`,
    `68.183.218.85`,
    `164.68.112.227`,
    `164.68.102.167`,
    `207.180.211.50`,
    `165.227.87.65`,
    `172.107.204.217`,
    `91.92.128.231`,
    `117.20.64.116`,
    `164.68.102.160`,
    `14.161.22.95`,
    `167.86.124.242`,
    `167.86.90.110`,
    `207.180.204.80`,
    `135.181.85.199`,
    `135.181.85.197`,
    `135.181.85.194`,
    `135.181.85.195`,
    `135.181.85.193`,
    `195.201.22.153`,
    `195.201.22.163`,
    `195.201.22.187`,
    `195.201.22.192`,
    `195.201.22.135`,
    `195.201.22.154`,
    `195.201.22.170`,
    `195.201.22.178`,
    `195.201.22.189`,
    `195.201.22.132`,
    `135.181.85.203`,
    `135.181.85.204`,
    `178.23.222.2`,
    `167.86.90.86`,
    `207.180.211.40`,
    `213.52.125.42`,
    `45.79.239.226`,
    `207.180.206.21`,
    `89.200.172.119`,
    `207.180.216.178`,
    `167.86.91.153`,
    `167.86.112.198`,
    `164.68.112.218`,
    `173.249.36.55`,
    `167.86.87.59`,
    `167.86.124.238`,
    `167.86.97.26`,
    `51.77.91.4`,
    `174.89.118.143`,
    `173.249.15.232`,
    `168.119.57.76`,
    `168.119.57.78`,
    `168.119.57.75`,
    `135.181.85.212`,
    `135.181.85.159`,
    `135.181.36.193`,
    `135.181.85.149`,
    `95.217.19.237`,
    `95.217.221.28`,
    `95.216.189.91`,
    `135.181.85.150`,
    `135.181.85.171`,
    `167.86.91.64`,
    `90.145.247.148`,
    `185.144.28.222`,
    `173.212.223.176`,
    `164.68.102.148`,
    `164.68.112.220`,
    `85.217.171.116`,
    `90.145.247.150`,
    `167.86.80.36`,
    `207.180.211.144`,
    `167.86.97.7`,
    `99.80.82.23`,
    `167.86.79.34`,
    `167.86.94.165`,
    `173.82.151.10`,
    `51.77.124.7`,
    `167.86.88.165`,
    `45.140.168.218`,
    `124.187.44.212`,
    `207.180.251.161`,
    `167.86.91.140`,
    `167.86.97.4`,
    `167.86.90.132`,
    `167.86.88.222`,
    `167.86.91.133`,
    `167.86.93.226`,
    `167.86.97.10`,
    `45.32.126.230`,
    `167.86.97.27`,
    `95.179.190.8`,
    `217.69.5.79`,
    `167.86.90.167`,
    `167.86.124.236`,
    `167.86.71.165`,
    `185.203.119.229`,
    `178.238.235.223`,
    `207.180.229.173`,
    `51.158.191.187`,
    `207.180.193.10`,
    `213.136.88.211`,
    `167.86.124.245`,
    `208.64.227.82`,
    `207.180.196.81`,
    `173.249.15.183`,
    `212.227.211.87`,
    `45.80.152.12`,
    `207.180.204.56`,
    `167.86.90.46`,
    `173.249.27.22`,
    `51.15.43.204`,
    `173.249.13.18`,
    `172.105.60.87`,
    `68.183.165.70`,
    `188.166.121.129`,
    `207.180.202.120`,
    `51.77.124.12`,
    `167.86.97.24`,
    `173.82.212.62`,
    `95.217.215.17`,
    `195.201.23.0`,
    `195.201.22.255`,
    `195.201.22.238`,
    `195.201.22.96`,
    `195.201.23.2`,
    `195.201.22.249`,
    `195.201.22.233`,
    `195.201.22.254`,
    `167.86.79.59`,
    `167.86.124.230`,
    `207.180.216.124`,
    `167.86.124.233`,
    `207.180.206.97`,
    `207.180.246.218`,
    `207.180.212.197`,
    `167.86.124.237`,
    `164.68.102.156`,
    `167.86.90.75`,
    `167.86.124.251`,
    `54.38.150.119`,
    `207.180.207.146`,
    `51.77.124.18`,
    `157.230.214.214`,
    `164.68.102.166`,
    `213.52.125.43`,
    `45.76.34.140`,
    `207.180.202.230`,
    `45.63.43.164`,
    `51.75.158.103`,
    `193.38.33.123`,
    `167.86.88.157`,
    `207.180.200.239`,
    `173.249.51.210`,
    `167.86.81.59`,
    `51.75.158.111`,
    `78.60.219.169`,
    `173.249.16.58`,
    `167.86.91.99`,
    `164.68.112.216`,
    `207.180.210.63`,
    `167.86.124.228`,
    `164.68.112.215`,
    `167.86.91.98`,
    `164.68.102.163`,
    `173.249.24.50`,
    `167.86.124.241`,
    `51.77.124.22`,
    `167.86.91.55`,
    `173.249.28.149`,
    `173.212.247.22`,
    `173.212.252.120`,
    `207.180.234.61`,
    `90.145.247.162`,
    `167.86.87.57`,
    `167.86.91.12`,
    `51.75.158.23`,
    `173.249.15.238`,
    `167.86.89.215`,
    `185.141.61.179`,
    `207.180.218.18`,
    `167.86.89.6`,
    `173.249.21.154`,
    `173.249.60.78`,
    `209.250.224.212`,
    `167.86.103.114`,
    `95.179.149.67`,
    `70.52.79.114`,
    `164.68.102.158`,
    `164.68.102.162`,
    `173.249.23.24`,
    `167.86.90.25`,
    `167.86.88.137`,
    `95.111.235.137`,
    `167.86.88.200`,
    `95.179.199.47`,
    `167.86.71.164`,
    `167.86.85.147`,
    `167.86.110.23`,
    `51.210.243.4`,
    `164.68.102.150`,
    `89.149.208.133`,
    `173.212.211.55`,
    `167.86.90.88`,
    `90.145.247.176`,
    `207.180.227.207`,
    `79.143.181.118`,
    `167.86.87.54`,
    `173.249.14.78`,
    `173.249.46.109`,
    `109.87.231.183`,
    `51.38.101.172`,
    `173.249.11.196`,
    `167.86.112.151`,
    `90.145.247.177`,
    `51.77.227.47`,
    `167.86.91.156`,
    `95.179.219.105`,
    `195.201.3.145`,
    `93.188.165.193`,
    `158.247.227.242`,
    `45.32.183.71`,
    `167.86.88.160`,
    `167.86.124.232`,
    `89.200.172.159`,
    `51.77.124.2`,
    `167.86.103.117`,
    `167.86.91.2`,
    `172.104.36.13`,
    `45.32.236.166`,
    `167.86.96.5`,
    `90.145.247.168`,
    `173.212.225.161`,
    `51.77.227.30`,
    `54.38.221.37`,
    `167.86.97.21`,
    `164.68.102.149`,
    `80.241.213.83`,
    `62.171.132.113`,
    `173.249.18.165`,
    `149.28.162.235`,
    `91.92.136.194`,
    `167.86.124.250`,
    `167.86.97.8`,
    `167.86.97.19`,
    `164.68.102.154`,
    `165.227.173.131`,
];

async function getEnabledNodes() {
    let date = new Date();
    let fileName = 'servers' + date.getFullYear() + date.getMonth() + date.getDate() + '.txt';

    try {        
        if(!fs.existsSync(fileName)){
            let nodes = await fetch('https://sapi.smartcash.cc/v1/smartnode/check/ENABLED');
            nodes = await nodes.json();
            console.log(nodes);
            const servers = nodes.map((node) => 'http://' + node.ip.replace(':9678', ':8080'));

            fs.writeFileSync(fileName, JSON.stringify(servers));
        }

        return JSON.parse(fs.readFileSync(fileName));
    } catch (err) {
        console.error(err);
    }
}

getEnabledNodes();

function electedSapi(){
    return sapis[Math.floor(Math.random() * sapis.length)];
}

function getRandomSapiUrl() {    
    let prefix = `http://${electedSapi()}:8080`;
    console.log(prefix);
    return prefix;    
}

const options = {
    target: getRandomSapiUrl(),
    changeOrigin: true,
    onProxyReq: (proxyReq, req, res) => {
        proxyReq.setHeader('host', electedSapi());   
    },
    onProxyRes: (onProxyRes, req, res) => {
       console.log(onProxyRes);
    },
};

// create the proxy (without context)
const sapiProxy = createProxyMiddleware(options);

app.use('/v1', sapiProxy);

app.get('/', function(req, res) {
    res.sendFile(distDir + 'index.html');
});

app.get('/home', function(req, res) {
    res.sendFile(distDir + 'index.html');
});

app.get('/tx/*', function(req, res) {
    res.sendFile(distDir + 'index.html');
});

app.get('/block/*', function(req, res) {
    res.sendFile(distDir + 'index.html');
});

app.get('/address/*', function(req, res) {
    res.sendFile(distDir + 'index.html');
});

app.get('/ext/getmoneysupply', function(req, res) {
    res.setHeader('Content-Type', 'application/json');
    fetch('https://sapi.smartcash.cc/v1/blockchain/supply')
        .then(res => res.json())
        .then(json => {
            res.send(json.CurrentSupply.toString());
        });
});

// // THOSE BLOCKS must use the right function from SAPI
// // THEY MUST USE THE GET_RANDOM_SAPI function as well

// app.get('/api/blocks', function(req, res) {
//     res.setHeader('Content-Type', 'application/json');
//     fetch('https://sapi.smartcash.cc/v1/')
//         .then(res => res.json())
//         .then(json => {
//             res.send(json);
//         });
// });

// app.get('/api/block/{hash}', function(req, res) {
//     res.setHeader('Content-Type', 'application/json');
//     fetch('https://sapi.smartcash.cc/v1/')
//         .then(res => res.json())
//         .then(json => {
//             res.send(json);
//         });
// });

// app.get('/api/transactions', function(req, res) {
//     res.setHeader('Content-Type', 'application/json');
//     fetch('https://sapi.smartcash.cc/v1/')
//         .then(res => res.json())
//         .then(json => {
//             res.send(json);
//         });
// });

// app.get('/api/transaction/{txid}', function(req, res) {
//     res.setHeader('Content-Type', 'application/json');
//     fetch('https://sapi.smartcash.cc/v1/')
//         .then(res => res.json())
//         .then(json => {
//             res.send(json);
//         });
// });

// app.get('/api/address/{address}', function(req, res) {
//     res.setHeader('Content-Type', 'application/json');
//     fetch('https://sapi.smartcash.cc/v1/')
//         .then(res => res.json())
//         .then(json => {
//             res.send(json);
//         });
// });

// //Melhor exemplo!

// app.get('/api/smartrewards/roi', function(req, res) {
//     res.setHeader('Content-Type', 'application/json');
//     fetch('https://sapi.smartcash.cc/v1/smartrewards/roi')
//         .then(res => res.json())
//         .then(json => {
//             res.send(json);
//         });
// });

// app.get('/api/smartnode/roi', function(req, res) {
//     res.setHeader('Content-Type', 'application/json');
//     fetch('https://sapi.smartcash.cc/v1/smartnode/roi')
//         .then(res => res.json())
//         .then(json => {
//             res.send(json);
//         });
// });

module.exports = app;
